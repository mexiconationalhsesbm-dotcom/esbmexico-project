(()=>{var e={};e.id=4915,e.ids=[4915],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34319:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>k,routeModule:()=>g,serverHooks:()=>x,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>I});var a={};t.r(a),t.d(a,{POST:()=>m});var s=t(96559),i=t(48088),o=t(37719),n=t(32190),d=t(76033),c=t(23607),l=t(83398),u=t.n(l);let p=require("@aws-sdk/client-s3"),f=(0,c.UU)("https://kegskzgwkhltieyddbby.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1}});async function m(e){try{let r=await (0,d.U)(),{data:{user:t}}=await r.auth.getUser();if(!t)return n.NextResponse.json({error:"Unauthorized"},{status:401});let{folderId:a,dimensionId:s}=await e.json();if(!a||!s)return n.NextResponse.json({error:"Folder ID and Dimension ID required"},{status:400});let{data:i}=await r.from("folders").select("id, name, dimension_id").eq("id",a).single(),{data:o}=await r.from("dimensions").select("id, name").eq("id",s).single();if(!i||i.dimension_id!==Number(s))return n.NextResponse.json({error:"Folder not found"},{status:404});let c=new(u());await w(f,c,a,s,"");let l=await c.generateAsync({type:"nodebuffer"}),p=process.env.ARCHIVE_STORAGE_PROVIDER||"backblaze",m=`archived-folders/${o?.name}/${i.name}/${i.name}.zip`,g="";"backblaze"===p?g=await h(l,m,i.name):"gcs"===p&&(g=await _(l,m,i.name));let y=await v(f,a,s);return await r.from("archived_folders").insert({folder_id:a,folder_name:i.name,dimension_id:s,original_folder_structure:y,archived_by:t.id,storage_provider:p,storage_path:m,storage_url:g}),await r.from("folders").update({cloud_archive:!0,updated_at:new Date().toISOString()}).eq("id",a),n.NextResponse.json({success:!0,message:"Folder archived to cloud storage",storageUrl:g})}catch(e){return console.error("Error in cloud archive:",e),n.NextResponse.json({error:e.message||"Failed to archive to cloud"},{status:500})}}async function h(e,r,t){let a=new p.S3Client({region:process.env.B2_BUCKET_REGION,endpoint:`https://s3.${process.env.B2_BUCKET_REGION}.backblazeb2.com`,credentials:{accessKeyId:process.env.B2_APPLICATION_KEY_ID,secretAccessKey:process.env.B2_APPLICATION_KEY}}),s=new p.PutObjectCommand({Bucket:process.env.B2_BUCKET_NAME,Key:r,Body:e,ContentType:"application/zip"});await a.send(s);let i=process.env.B2_BUCKET_BASE_URL,o=`${i}/${r}`;return console.log(`âœ… Uploaded to Backblaze: ${o}`),o}async function _(e,r,t){return console.log(`Uploading to GCS: ${r}`),`https://gcs-placeholder.com/${r}`}async function v(e,r,t){let{data:a}=await e.from("folders").select("id, name").eq("id",r).single(),s={id:a.id,name:a.name,type:"folder",children:[]},{data:i}=await e.from("folders").select("id, name").eq("parent_folder_id",r);for(let r of i||[]){let a=await v(e,r.id,t);s.children?.push(a)}let{data:o}=await e.from("files").select("id, name, file_size").eq("folder_id",r);for(let e of o||[])s.children?.push({id:e.id,name:e.name,type:"file",size:e.file_size});return s}async function w(e,r,t,a,s){let{data:i}=await e.from("files").select("id, name, file_path").eq("folder_id",t);for(let t of i||[])try{let{data:a,error:i}=await e.storage.from("files").download(t.file_path);if(!i&&a){let e=await a.arrayBuffer(),i=Buffer.from(e),o=s?`${s}/${t.name}`:t.name;r.file(o,i)}}catch(e){console.error(`Error processing file ${t.name}:`,e)}let{data:o}=await e.from("folders").select("id, name").eq("parent_folder_id",t);for(let t of o||[]){let i=s?`${s}/${t.name}`:t.name;await w(e,r,t.id,a,i)}}let g=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/archive/cloud-archive/route",pathname:"/api/archive/cloud-archive",filename:"route",bundlePath:"app/api/archive/cloud-archive/route"},resolvedPagePath:"C:\\Users\\Jave\\Desktop\\research\\esbmexico\\src\\app\\api\\archive\\cloud-archive\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:y,workUnitAsyncStorage:I,serverHooks:x}=g;function k(){return(0,o.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:I})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},76033:(e,r,t)=>{"use strict";t.d(r,{U:()=>i});var a=t(34386),s=t(44999);async function i(){let e=await (0,s.UL)();return(0,a.createServerClient)("https://kegskzgwkhltieyddbby.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtlZ3Nremd3a2hsdGlleWRkYmJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyOTMyMzQsImV4cCI6MjA2Mzg2OTIzNH0.daWkoPRZZsqlhRINmeWDSe1cm6JwRP7rf_jy1npw-7Q",{cookies:{getAll:()=>e.getAll(),setAll(r){try{r.forEach(({name:r,value:t,options:a})=>e.set(r,t,a))}catch{}}}})}},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[7719,3607,580,4999,4386,3398],()=>t(34319));module.exports=a})();